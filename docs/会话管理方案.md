# TermiClaude ä¼šè¯ç®¡ç†æ·±åº¦åˆ†ææŠ¥å‘Š

> æœ¬æ–‡æ¡£åŸºäºå¯¹ termiClaude é¡¹ç›®çš„æ·±å…¥ä»£ç å®¡æŸ¥ï¼Œå…¨é¢åˆ†æä¼šè¯æœŸé—´å’Œå¹¶å‘ä¼šè¯æœŸé—´å¯èƒ½å­˜åœ¨çš„ä¸Šä¸‹æ–‡ä¸¢å¤±ã€æ¶ˆæ¯é”™ä¹±ç­‰é—®é¢˜ï¼Œå¹¶æä¾›è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆã€‚

## ç›®å½•
1. [å•ä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜](#å•ä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜)
2. [å¤šä¼šè¯å¹¶å‘é—®é¢˜](#å¤šä¼šè¯å¹¶å‘é—®é¢˜)
3. [åç«¯è¿›ç¨‹ç®¡ç†é—®é¢˜](#åç«¯è¿›ç¨‹ç®¡ç†é—®é¢˜)
4. [æ–‡ä»¶ç³»ç»Ÿå¹¶å‘é—®é¢˜](#æ–‡ä»¶ç³»ç»Ÿå¹¶å‘é—®é¢˜)
5. [è§£å†³æ–¹æ¡ˆæ±‡æ€»](#è§£å†³æ–¹æ¡ˆæ±‡æ€»)
6. [å®æ–½ä¼˜å…ˆçº§](#å®æ–½ä¼˜å…ˆçº§)

---

## å•ä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜

### **ä¸»è¦ä¸Šä¸‹æ–‡ä¸¢å¤±åŸå› **

### 1. **Reactç»„ä»¶çŠ¶æ€é‡ç½®**ï¼ˆæœ€å¯èƒ½çš„åŸå› ï¼‰

- **é—®é¢˜**ï¼š`useClaudeMessages.ts:56-59`ä¸­ä½¿ç”¨`useState`ç®¡ç†æ¶ˆæ¯çŠ¶æ€ï¼Œå½“ç”¨æˆ·åˆ·æ–°é¡µé¢ã€å¯¼èˆªæˆ–åº”ç”¨é‡å¯æ—¶ï¼ŒReactç»„ä»¶é‡æ–°æŒ‚è½½å¯¼è‡´çŠ¶æ€ä¸¢å¤±
- **å½±å“**ï¼šæ‰€æœ‰å†å²æ¶ˆæ¯ã€å½“å‰ä¼šè¯IDã€ç´¯ç§¯å†…å®¹éƒ½ä¼šè¢«æ¸…ç©º

### 2. **ä¼šè¯IDç®¡ç†é”™è¯¯**

- **é—®é¢˜**ï¼šåœ¨`api.ts:1164-1189`ä¸­æœ‰å¤šä¸ªClaude Codeæ‰§è¡Œå‡½æ•°ï¼ˆ`executeClaudeCode`ã€`continueClaudeCode`ã€`resumeClaudeCode`ï¼‰ï¼Œä¼šè¯IDåœ¨ä¸åŒæ“ä½œé—´å¯èƒ½ä¸¢å¤±æˆ–æ··æ·†
- **å½±å“**ï¼šæ— æ³•æ­£ç¡®åŠ è½½æˆ–ç»§ç»­ä¹‹å‰çš„å¯¹è¯å†å²

### 3. **åç«¯è¿›ç¨‹å¼‚å¸¸**

- **é—®é¢˜**ï¼šClaude Codeé€šè¿‡å­è¿›ç¨‹è¿è¡Œï¼Œå¦‚æœè¿›ç¨‹æ„å¤–ç»ˆæ­¢æˆ–è¢«æ¸…ç†ç¨‹åºè¯¯åˆ é™¤ï¼Œä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±
- **ç›¸å…³ä»£ç **ï¼š`api.ts:1074-1083`çš„`cleanupFinishedProcesses`å¯èƒ½è¯¯æ¸…ç†æ­£åœ¨ä½¿ç”¨çš„ä¼šè¯

### 4. **äº‹ä»¶ç³»ç»Ÿä¸ç¨³å®š**

- **é—®é¢˜**ï¼šä¾èµ–Tauriäº‹ä»¶ç³»ç»Ÿï¼ˆ`useClaudeMessages.ts:175-182`ï¼‰è¿›è¡Œæ¶ˆæ¯ä¼ è¾“ï¼Œäº‹ä»¶ä¸¢å¤±æˆ–ç›‘å¬å™¨å¼‚å¸¸ä¼šå¯¼è‡´æ¶ˆæ¯æµä¸­æ–­

## **è§£å†³æ–¹æ¡ˆå»ºè®®**

### **ç«‹å³å¯å®æ–½çš„ä¿®å¤ï¼š**

1. **å®ç°ä¼šè¯çŠ¶æ€æŒä¹…åŒ–**

```
// åœ¨ useClaudeMessages.ts ä¸­æ·»åŠ 
useEffect(() => {
  // ä¿å­˜ä¼šè¯çŠ¶æ€åˆ° localStorage
  if (currentSessionId) {
    localStorage.setItem('currentSessionId', currentSessionId);
    localStorage.setItem('sessionMessages', JSON.stringify(messages));
  }
}, [currentSessionId, messages]);

// ç»„ä»¶æŒ‚è½½æ—¶æ¢å¤çŠ¶æ€
useEffect(() => {
  const savedSessionId = localStorage.getItem('currentSessionId');
  const savedMessages = localStorage.getItem('sessionMessages');
  if (savedSessionId && savedMessages) {
    setCurrentSessionId(savedSessionId);
    setMessages(JSON.parse(savedMessages));
  }
}, []);
```

1. **æ·»åŠ ä¼šè¯è¿æ¥çŠ¶æ€æ£€æŸ¥**

```
// å®šæœŸæ£€æŸ¥ä¼šè¯æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
const validateSession = useCallback(async () => {
  if (currentSessionId) {
    try {
      const status = await api.getSessionStatus(currentSessionId);
      if (!status) {
        // ä¼šè¯å·²å¤±æ•ˆï¼Œå°è¯•æ¢å¤
        await loadMessages(currentSessionId);
      }
    } catch (error) {
      console.warn('Session validation failed:', error);
    }
  }
}, [currentSessionId, loadMessages]);
```

1. **æ”¹è¿›é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶**

```
const loadMessages = useCallback(async (sessionId: string, projectId?: string, retryCount = 0) => {
  try {
    // ç°æœ‰çš„åŠ è½½é€»è¾‘...
  } catch (error) {
    if (retryCount < 3) {
      // å»¶è¿Ÿåé‡è¯•
      setTimeout(() => loadMessages(sessionId, projectId, retryCount + 1), 1000);
    } else {
      logger.error("Failed to load session history after retries:", error);
    }
  }
}, []);
```

### **ä¸­é•¿æœŸæ¶æ„æ”¹è¿›ï¼š**

1. **ä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†**
   - å°†ä¼šè¯çŠ¶æ€ä»ç»„ä»¶çº§åˆ«æå‡åˆ°åº”ç”¨çº§åˆ«ï¼ˆä½¿ç”¨Zustandï¼‰
   - å®ç°ä¼šè¯çŠ¶æ€çš„è‡ªåŠ¨åŒæ­¥å’Œå¤‡ä»½
2. **å¢å¼ºåç«¯è¿›ç¨‹ç®¡ç†**
   - æ”¹è¿›`cleanupFinishedProcesses`é€»è¾‘ï¼Œé¿å…è¯¯æ¸…ç†æ´»è·ƒä¼šè¯
   - æ·»åŠ ä¼šè¯å¿ƒè·³æ£€æŸ¥æœºåˆ¶
   - å®ç°ä¼šè¯æ•°æ®çš„å®šæœŸå¤‡ä»½
3. **æ”¹è¿›ç”¨æˆ·ä½“éªŒ**
   - æ˜¾ç¤ºå½“å‰ä¼šè¯è¿æ¥çŠ¶æ€
   - åœ¨ä¸Šä¸‹æ–‡ä¸¢å¤±æ—¶æä¾›æ˜ç¡®æç¤ºå’Œæ¢å¤é€‰é¡¹
   - æ·»åŠ æ‰‹åŠ¨é‡æ–°è¿æ¥åŠŸèƒ½

## **è°ƒè¯•å»ºè®®**

åœ¨`src/lib/logger.ts`ä¸­æ·»åŠ ä¼šè¯çŠ¶æ€è¿½è¸ªï¼š

```
// è¿½è¸ªä¼šè¯çŠ¶æ€å˜åŒ–
logger.debug('Session state change:', {
  sessionId: currentSessionId,
  messageCount: messages.length,
  isStreaming,
  timestamp: new Date().toISOString()
});
```

è¿™äº›æ”¹è¿›å°†æ˜¾è‘—å‡å°‘ä¸Šä¸‹æ–‡ä¸¢å¤±çš„æƒ…å†µï¼Œå¹¶åœ¨å‘ç”Ÿé—®é¢˜æ—¶æä¾›æ›´å¥½çš„æ¢å¤æœºåˆ¶ã€‚å»ºè®®ä¼˜å…ˆå®æ–½æŒä¹…åŒ–å’Œé”™è¯¯å¤„ç†æ”¹è¿›ï¼Œè¿™äº›æ˜¯æœ€ç›´æ¥æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚







## **ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå¯èƒ½ç›´æ¥å¯¼è‡´ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼‰**

### 1. **Claude Sessionè¿›ç¨‹æ¸…ç†Bug**ï¼ˆæœ€ä¸¥é‡ï¼ï¼‰

- **ä½ç½®**ï¼š`src-tauri/src/process/registry.rs:120-152`

- é—®é¢˜

  ï¼šClaude sessionsåœ¨æ³¨å†Œæ—¶

  ```
  child handle
  ```

  è®¾ä¸º

  ```
  None
  ```

  ```
  pub fn register_claude_session(...) -> Result<i64, String> {
      // ...
      let process_handle = ProcessHandle {
          info: process_info,
          child: Arc::new(Mutex::new(None)), // âŒ æ²¡æœ‰child handle
          live_output: Arc::new(Mutex::new(String::new())),
      };
  }
  ```

- **å½±å“**ï¼š`is_process_running`æ£€æŸ¥child handleæ¥åˆ¤æ–­è¿›ç¨‹æ˜¯å¦è¿è¡Œï¼Œå¯¹äºClaude sessionsæ€»æ˜¯è¿”å›`false`ï¼Œå¯¼è‡´`cleanup_finished_processes`è¯¯åˆ é™¤æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ï¼

- ä¿®å¤å»ºè®®

  ï¼š

  ```
  // ä¸ºClaude sessionså®ç°ä¸“é—¨çš„å­˜æ´»æ£€æŸ¥
  pub fn is_claude_session_running(&self, session_id: &str) -> Result<bool, String> {
      // é€šè¿‡æ£€æŸ¥è¿›ç¨‹PIDæˆ–ä¼šè¯æ–‡ä»¶æ¥åˆ¤æ–­
      // è€Œä¸æ˜¯ä¾èµ–child handle
  }
  ```

### 2. **ä¼šè¯æ–‡ä»¶å¹¶å‘è®¿é—®å†²çª**

- **ä½ç½®**ï¼š`src-tauri/src/commands/claude.rs:1450-1526`

- é—®é¢˜

  ï¼š

  - `load_session_history`è¯»å–JSONLæ–‡ä»¶æ—¶ï¼Œå¯èƒ½æ­£åœ¨è¢«å†™å…¥
  - `save_session_history`å†™å…¥æ—¶ï¼Œå¯èƒ½æ­£åœ¨è¢«è¯»å–
  - Windowsæ–‡ä»¶é”æ¯”Unixæ›´ä¸¥æ ¼ï¼Œæ›´å®¹æ˜“å†²çª

- **ç—‡çŠ¶**ï¼šè¯»å–åˆ°ä¸å®Œæ•´çš„JSONå¯¼è‡´è§£æå¤±è´¥ï¼Œå†å²æ¶ˆæ¯ä¸¢å¤±

- ä¿®å¤å»ºè®®

  ï¼š

  ```
  // ä½¿ç”¨æ–‡ä»¶é”æœºåˆ¶
  use fs2::FileExt;
  
  let file = fs::File::open(&session_path)?;
  file.lock_shared()?; // è¯»å–æ—¶å…±äº«é”
  // ... è¯»å–æ“ä½œ
  file.unlock()?;
  ```

### 3. **ä¼šè¯IDä¼ é€’é“¾è·¯æ–­è£‚**

- **é—®é¢˜**ï¼š`executeClaudeCode` â†’ `continueClaudeCode` â†’ `resumeClaudeCode`ä¸‰ä¸ªå‡½æ•°ä½¿ç”¨ä¸åŒçš„å‚æ•°

- **å½±å“**ï¼šå¦‚æœå‰ç«¯åœ¨åˆ‡æ¢æ—¶æ²¡æœ‰æ­£ç¡®ä¼ é€’sessionIdï¼Œä¼šåˆ›å»ºæ–°ä¼šè¯è€Œéç»§ç»­æ—§ä¼šè¯

- å…·ä½“åœºæ™¯

  ï¼š

  ```
  // âŒ é”™è¯¯ï¼šæ²¡æœ‰ä¼ é€’sessionId
  await api.continueClaudeCode(projectPath, prompt, model);
  
  // âœ… æ­£ç¡®ï¼šæ˜¾å¼ä¼ é€’sessionId
  await api.resumeClaudeCode(projectPath, currentSessionId, prompt, model);
  ```

## **ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå½±å“ç¨³å®šæ€§ï¼‰**

### 4. **å†…å­˜æ³„æ¼é£é™©**

- **ä½ç½®**ï¼š`registry.rs:482-490`

- é—®é¢˜

  ï¼š

  ```
  live_output
  ```

  å­—ç¬¦ä¸²æŒç»­ç´¯ç§¯ï¼Œæ— é™åˆ¶å¢é•¿

  ```
  pub fn append_live_output(&self, run_id: i64, output: &str) -> Result<(), String> {
      // âŒ æ— é™ç´¯ç§¯ï¼Œæ²¡æœ‰å¤§å°é™åˆ¶
      live_output.push_str(output);
      live_output.push('\n');
  }
  ```

- **å½±å“**ï¼šé•¿æ—¶é—´å¯¹è¯å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œç¨‹åºå´©æºƒï¼Œä¸Šä¸‹æ–‡ä¸¢å¤±

- ä¿®å¤å»ºè®®

  ï¼š

  ```
  // é™åˆ¶è¾“å‡ºç¼“å†²åŒºå¤§å°
  const MAX_OUTPUT_SIZE: usize = 10 * 1024 * 1024; // 10MB
  if live_output.len() > MAX_OUTPUT_SIZE {
      // ä¿ç•™æœ€åçš„éƒ¨åˆ†ï¼Œä¸¢å¼ƒæ—§æ•°æ®
      *live_output = live_output.split_off(MAX_OUTPUT_SIZE / 2);
  }
  ```

### 5. **æ¨¡å‹é…ç½®å¤šæºä¸åŒæ­¥**

- **ä½ç½®**ï¼š`claude.rs:1100-1165`

- é—®é¢˜

  ï¼šæ¨¡å‹é€‰æ‹©å­˜å‚¨åœ¨ä¸‰ä¸ªåœ°æ–¹ï¼š

  1. localStorageï¼ˆå‰ç«¯ï¼‰
  2. app_settingsè¡¨ï¼ˆæ•°æ®åº“ï¼‰
  3. settings.jsonï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰

- **å½±å“**ï¼šå¦‚æœè¿™äº›å­˜å‚¨ä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´æ¯æ¬¡å¯¹è¯ä½¿ç”¨ä¸åŒæ¨¡å‹ï¼Œç ´åä¸Šä¸‹æ–‡è¿ç»­æ€§

- **ä¿®å¤å»ºè®®**ï¼šç»Ÿä¸€ä½¿ç”¨å•ä¸€å¯ä¿¡æ¥æºï¼Œå…¶ä»–ä½ç½®ä½œä¸ºç¼“å­˜

### 6. **Tauriäº‹ä»¶ç³»ç»Ÿå¯é æ€§**

- é—®é¢˜

  ï¼š

  - äº‹ä»¶å‘é€é€Ÿåº¦è¿‡å¿«å¯èƒ½å¯¼è‡´é˜Ÿåˆ—æº¢å‡º
  - å‰ç«¯å¤„ç†äº‹ä»¶æ—¶å¼‚å¸¸ä¼šå¯¼è‡´åç»­äº‹ä»¶ä¸¢å¤±
  - ç½‘ç»œå»¶è¿Ÿï¼ˆè™½ç„¶æ˜¯æœ¬åœ°IPCï¼‰å¯èƒ½å¯¼è‡´äº‹ä»¶ä¹±åº

- ä¿®å¤å»ºè®®

  ï¼š

  ```
  // æ·»åŠ äº‹ä»¶åºåˆ—å·å’Œç¡®è®¤æœºåˆ¶
  interface StreamMessage {
      sequence: number;
      data: any;
  }
  
  // å‰ç«¯ç»´æŠ¤æœŸæœ›çš„åºåˆ—å·ï¼Œæ£€æµ‹ä¸¢å¤±
  ```

## **ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆè¾¹ç¼˜æƒ…å†µï¼‰**

### 7. **é”™è¯¯å¤„ç†å’Œé‡è¯•ä¸è¶³**

- `loadMessages`å¤±è´¥æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ²¡æœ‰é‡è¯•
- æ–‡ä»¶è§£æé”™è¯¯æ—¶ä»…è®°å½•æ—¥å¿—ï¼Œä¸é€šçŸ¥ç”¨æˆ·

### 8. **è°ƒè¯•å’Œç›‘æ§ç¼ºå¤±**

- ç¼ºå°‘ä¼šè¯çŠ¶æ€å˜åŒ–çš„è¯¦ç»†æ—¥å¿—
- éš¾ä»¥è¿½è¸ªä¸Šä¸‹æ–‡ä¸¢å¤±çš„æ ¹æœ¬åŸå› 

## **ç«‹å³è¡ŒåŠ¨å»ºè®®**

**æœ€ç´§æ€¥çš„ä¿®å¤ï¼ˆå¿…é¡»é©¬ä¸Šåšï¼‰ï¼š**

1. ä¿®å¤Claude Sessionçš„è¿›ç¨‹æ¸…ç†é€»è¾‘ï¼Œé¿å…è¯¯åˆ é™¤æ´»è·ƒä¼šè¯
2. åœ¨`useClaudeMessages`ä¸­æ·»åŠ sessionIdæŒä¹…åŒ–å’Œæ¢å¤
3. å®ç°JSONLæ–‡ä»¶çš„å¹¶å‘è®¿é—®æ§åˆ¶

**å»ºè®®çš„æ£€æŸ¥æ¸…å•ï¼š**

```
// åœ¨å‰ç«¯æ·»åŠ è°ƒè¯•æ—¥å¿—
console.log('[Session Debug]', {
    sessionId: currentSessionId,
    messageCount: messages.length,
    isStreaming,
    timestamp: Date.now()
});

// å®šæœŸéªŒè¯ä¼šè¯è¿æ¥
setInterval(async () => {
    if (currentSessionId) {
        const isValid = await api.getSessionStatus(currentSessionId);
        if (!isValid) {
            console.warn('[Session Lost] Attempting recovery...');
            await loadMessages(currentSessionId, projectId);
        }
    }
}, 5000);
```

è¿™äº›é—®é¢˜ä¸­ï¼Œ**è¿›ç¨‹æ¸…ç†bug**å’Œ**ä¼šè¯IDä¼ é€’æ–­è£‚**æ˜¯æœ€å¯èƒ½å¯¼è‡´ä½ é‡åˆ°çš„ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼





## ä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±çš„æ ¹æœ¬åŸå› åˆ†æ

### 1. **Reactç»„ä»¶çŠ¶æ€ç®¡ç†é—®é¢˜**ï¼ˆæœ€ä¸»è¦çš„åŸå› ï¼‰

- `ClaudeCodeSession.tsx`ä¸­ä½¿ç”¨`useState`ç®¡ç†æ¶ˆæ¯çŠ¶æ€ï¼Œç»„ä»¶å¸è½½æ—¶çŠ¶æ€å®Œå…¨ä¸¢å¤±
- æ²¡æœ‰å®ç°çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶ï¼Œåˆ·æ–°é¡µé¢æˆ–ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶ä¼šä¸¢å¤±æ‰€æœ‰ä¸Šä¸‹æ–‡
- è™½ç„¶æœ‰[loadSessionHistory](file:///D:/github/termiClaude/src/components/ClaudeCodeSession.tsx#L681-L747)å‡½æ•°åŠ è½½å†å²æ¶ˆæ¯ï¼Œä½†ä¾èµ–äºåç«¯æ­£ç¡®ä¿å­˜å’Œæ¢å¤

### 2. **äº‹ä»¶ç›‘å¬å™¨ç®¡ç†ä¸å½“**

- ç»„ä»¶å¸è½½æ—¶ä¼šæ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆ`unlistenRefs.current.forEach((unlisten) => unlisten())`ï¼‰
- ä½†æ²¡æœ‰é€‚å½“çš„æ¢å¤æœºåˆ¶ï¼Œé‡æ–°æŒ‚è½½æ—¶éœ€è¦é‡æ–°å»ºç«‹ç›‘å¬å™¨è¿æ¥
- `isListeningRef.current`çŠ¶æ€åœ¨ç»„ä»¶å¸è½½æ—¶è¢«é‡ç½®ï¼Œä½†æ²¡æœ‰æŒä¹…åŒ–

### 3. **ä¼šè¯IDç®¡ç†ä¸ä¸€è‡´**

- [claudeSessionId](file:///D:/github/termiClaude/src/components/claude-code-session/SessionHeader.tsx#L28-L28)çŠ¶æ€åœ¨ç»„ä»¶å¸è½½æ—¶ä¸¢å¤±ï¼Œæ²¡æœ‰æŒä¹…åŒ–åˆ°localStorage
- é‡æ–°æŒ‚è½½æ—¶éœ€è¦é‡æ–°ä»[session](file:///D:/github/termiClaude/src/components/ClaudeCodeSession.tsx#L57-L57) propæˆ–`extractedSessionInfo`ä¸­è·å–
- ç¼ºä¹ä¼šè¯è¿æ¥çŠ¶æ€æ£€æŸ¥æœºåˆ¶

### 4. **åç«¯è¿›ç¨‹æ¸…ç†é—®é¢˜**

- `cleanupFinishedProcesses`å¯èƒ½è¯¯æ¸…ç†ä»åœ¨ä½¿ç”¨çš„ä¼šè¯è¿›ç¨‹
- ç¼ºä¹ä¼šè¯æ´»è·ƒçŠ¶æ€æ£€æŸ¥æœºåˆ¶

## å…·ä½“è§£å†³æ–¹æ¡ˆ

### 1. å®ç°ä¼šè¯çŠ¶æ€æŒä¹…åŒ–



ClaudeCodeSession.tsx



```
// ... existing code ... export const ClaudeCodeSession: React.FC<ClaudeCodeSessionProps> = ({  session,  initialProjectPath = "",  onBack,  onProjectSettings,  className,  onStreamingChange, }) => {  const { t } = useI18n();  // ... existing code ...    // æ·»åŠ ä¼šè¯çŠ¶æ€æŒä¹…åŒ–  useEffect(() => {    // ç»„ä»¶æŒ‚è½½æ—¶æ¢å¤çŠ¶æ€    const savedSessionId = localStorage.getItem('claudeSessionId');    const savedMessages = localStorage.getItem('sessionMessages');    const savedProjectPath = localStorage.getItem('projectPath');        if (savedSessionId && !claudeSessionId) {      setClaudeSessionId(savedSessionId);    }        if (savedMessages && messages.length === 0) {      try {        setMessages(JSON.parse(savedMessages));      } catch (e) {        logger.error("Failed to parse saved messages:", e);      }    }        if (savedProjectPath && !projectPath) {      setProjectPath(savedProjectPath);    }  }, []);    // æŒä¹…åŒ–ä¼šè¯çŠ¶æ€  useEffect(() => {    if (claudeSessionId) {      localStorage.setItem('claudeSessionId', claudeSessionId);    }  }, [claudeSessionId]);    useEffect(() => {    if (messages.length > 0) {      localStorage.setItem('sessionMessages', JSON.stringify(messages));    }  }, [messages]);    useEffect(() => {    if (projectPath) {      localStorage.setItem('projectPath', projectPath);    }  }, [projectPath]);    // ... existing code ...
```

### 2. æ”¹è¿›äº‹ä»¶ç›‘å¬å™¨ç®¡ç†



ClaudeCodeSession.tsx



```
// ... existing code ...  // Cleanup event listeners and track mount state  useEffect(() => {    isMountedRef.current = true;    // ä¸å†é‡ç½®isListeningRef.currentçŠ¶æ€ï¼Œä¿æŒç›‘å¬çŠ¶æ€        // Reset other states to ensure clean initialization    setError(null);    setRawJsonlOutput([]);    setQueuedPrompts([]);        // ä¸é‡ç½®hasActiveSessionRef.currentçŠ¶æ€        // ... existing code ...        return () => {      logger.debug("[ClaudeCodeSession] Component unmounting, cleaning up listeners");      isMountedRef.current = false;      // ä¸é‡ç½®isListeningRef.currentçŠ¶æ€ï¼Œä¿æŒç›‘å¬çŠ¶æ€            // ... existing code ...    };  }, [effectiveSession, projectPath, claudeSessionId, isLoading, session?.id]); // ... existing code ...
```

### 3. æ·»åŠ ä¼šè¯è¿æ¥çŠ¶æ€æ£€æŸ¥



ClaudeCodeSession.tsx



```
// ... existing code ...  // æ·»åŠ ä¼šè¯è¿æ¥çŠ¶æ€æ£€æŸ¥  const validateSession = useCallback(async () => {    if (claudeSessionId) {      try {        // æ£€æŸ¥ä¼šè¯æ˜¯å¦ä»ç„¶æœ‰æ•ˆ        const activeSessions = await api.listRunningClaudeSessions();        const isActive = activeSessions.some((s: any) => {          if (s.process_type?.ClaudeSession?.session_id === claudeSessionId) {            return true;          }          return false;        });                if (!isActive) {          // ä¼šè¯å·²å¤±æ•ˆï¼Œå°è¯•é‡æ–°åŠ è½½å†å²          logger.debug("[ClaudeCodeSession] Session no longer active, reloading history");          await loadSessionHistory();        }      } catch (error) {        logger.warn("Session validation failed:", error);      }    }  }, [claudeSessionId, loadSessionHistory]);    // å®šæœŸæ£€æŸ¥ä¼šè¯çŠ¶æ€  useEffect(() => {    if (claudeSessionId) {      const interval = setInterval(() => {        validateSession();      }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡            return () => clearInterval(interval);    }  }, [claudeSessionId, validateSession]); // ... existing code ...
```

### 4. æ”¹è¿›é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶



useClaudeMessages.ts



```
// ... existing code ...  const loadMessages = useCallback(async (sessionId: string, projectId?: string, retryCount = 0) => {    try {      let historyMessages: unknown[];            if (projectId) {        // Use the correct API function for loading session history with project ID        historyMessages = await api.loadSessionHistory(sessionId, projectId);      } else {        // Fallback to agent session history if no project ID        historyMessages = await api.loadAgentSessionHistory(sessionId);      }            const loadedMessages: ClaudeStreamMessage[] = [];      const loadedRawJsonl: string[] = [];       historyMessages.forEach((message) => {        try {          let parsedMessage: ClaudeStreamMessage;                    if (typeof message === 'object' && message !== null) {            // Message is already parsed            parsedMessage = message as ClaudeStreamMessage;            loadedRawJsonl.push(JSON.stringify(message));          } else if (typeof message === 'string') {            // Message is a JSON string            parsedMessage = JSON.parse(message) as ClaudeStreamMessage;            loadedRawJsonl.push(message);          } else {            // Skip invalid message types            return;          }                    loadedMessages.push(parsedMessage);        } catch (_e) {          logger.error("Failed to parse session history message:", _e);        }      });       setMessages(loadedMessages);      setRawJsonlOutput(loadedRawJsonl);    } catch (error) {      logger.error("Failed to load session history:", error);      // æ·»åŠ é‡è¯•æœºåˆ¶      if (retryCount < 3) {        logger.debug(`Retrying loadMessages (attempt ${retryCount + 1})`);        setTimeout(() => {          loadMessages(sessionId, projectId, retryCount + 1);        }, 1000 * (retryCount + 1)); // é€’å¢å»¶è¿Ÿé‡è¯•      } else {        throw error;      }    }  }, []); // ... existing code ...
```

è¿™äº›æ”¹è¿›å°†æ˜¾è‘—å‡å°‘ä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±çš„æƒ…å†µï¼Œå¹¶åœ¨å‘ç”Ÿé—®é¢˜æ—¶æä¾›æ›´å¥½çš„æ¢å¤æœºåˆ¶ã€‚ä¸»è¦æ”¹è¿›ç‚¹åŒ…æ‹¬ï¼š

1. **çŠ¶æ€æŒä¹…åŒ–**ï¼šå°†ä¼šè¯IDã€æ¶ˆæ¯å’Œé¡¹ç›®è·¯å¾„ä¿å­˜åˆ°localStorageï¼Œåœ¨ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶æ¢å¤
2. **è¿æ¥çŠ¶æ€æ£€æŸ¥**ï¼šå®šæœŸéªŒè¯ä¼šè¯æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼Œæ— æ•ˆæ—¶è‡ªåŠ¨é‡æ–°åŠ è½½å†å²
3. **æ”¹è¿›çš„é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œåœ¨åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
4. **ç›‘å¬å™¨ç®¡ç†ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„ç›‘å¬å™¨é‡ç½®ï¼Œä¿æŒè¿æ¥çŠ¶æ€

è¿™äº›ä¿®æ”¹ç›´æ¥è§£å†³äº†æ–‡æ¡£ä¸­æåˆ°çš„å››ä¸ªä¸»è¦é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯Reactç»„ä»¶çŠ¶æ€é‡ç½®å’Œä¼šè¯IDç®¡ç†é”™è¯¯è¿™ä¸¤ä¸ªæœ€å¯èƒ½çš„åŸå› ã€‚







ç»è¿‡æ·±å…¥åˆ†æå¤šä¼šè¯å¹¶å‘äº¤äº’çš„ä»£ç å®ç°ï¼Œæˆ‘å‘ç°äº†ä¸€äº›å¯èƒ½å¯¼è‡´å¼‚å¸¸é—®é¢˜çš„å…³é”®ç‚¹ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹åˆ†æç»“æœï¼š

## å¤šä¼šè¯å¹¶å‘äº¤äº’å¯èƒ½çš„å¼‚å¸¸é—®é¢˜åˆ†æ

### 1. **äº‹ä»¶ç›‘å¬å™¨å†²çªé—®é¢˜**

ä»ä»£ç åˆ†æå¯ä»¥çœ‹å‡ºï¼ŒTermiClaudeé‡‡ç”¨äº†å¤æ‚çš„äº‹ä»¶ç›‘å¬ç­–ç•¥æ¥å¤„ç†å¤šä¼šè¯ï¼š

1. **é€šç”¨ç›‘å¬å™¨**ï¼šé¦–å…ˆè®¾ç½®æ— åç¼€çš„é€šç”¨ç›‘å¬å™¨ï¼ˆå¦‚`claude-output`ï¼‰æ¥æ•è·æ‰€æœ‰ä¼šè¯çš„åˆå§‹æ¶ˆæ¯
2. **ä¼šè¯ç‰¹å®šç›‘å¬å™¨**ï¼šä¸€æ—¦è·å–åˆ°å…·ä½“çš„ä¼šè¯IDï¼Œå°±åˆ‡æ¢åˆ°ä¼šè¯ç‰¹å®šçš„ç›‘å¬å™¨ï¼ˆå¦‚`claude-output:{session_id}`ï¼‰
3. **ç›‘å¬å™¨åˆ‡æ¢æœºåˆ¶**ï¼šé€šè¿‡`attachSessionSpecificListeners`å‡½æ•°åŠ¨æ€åˆ‡æ¢ç›‘å¬å™¨

**æ½œåœ¨é—®é¢˜**ï¼š

- å½“å¤šä¸ªä¼šè¯åŒæ—¶è¿è¡Œæ—¶ï¼Œå¦‚æœç›‘å¬å™¨åˆ‡æ¢ä¸åŠæ—¶æˆ–ä¸æ­£ç¡®ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯è¢«é”™è¯¯çš„ä¼šè¯ç»„ä»¶å¤„ç†
- é€šç”¨ç›‘å¬å™¨å’Œç‰¹å®šç›‘å¬å™¨ä¹‹é—´å¯èƒ½å­˜åœ¨ç«äº‰æ¡ä»¶ï¼Œå¯¼è‡´æ¶ˆæ¯é‡å¤å¤„ç†æˆ–ä¸¢å¤±

### 2. **ä¼šè¯IDç®¡ç†å†²çª**

åœ¨å¤šä¼šè¯ç¯å¢ƒä¸­ï¼Œä»¥ä¸‹é—®é¢˜å¯èƒ½å‡ºç°ï¼š

1. **ä¼šè¯IDè¦†ç›–**ï¼š[currentSessionId](file:///D:/github/termiClaude/src/stores/sessionStore.ts#L20-L20)å˜é‡åœ¨å¤šä¸ªä¼šè¯é—´å…±äº«ï¼Œå¯èƒ½å¯¼è‡´ä¼šè¯IDæ··æ·†
2. **ç›‘å¬çŠ¶æ€åŒæ­¥**ï¼š`isListeningRef.current`çŠ¶æ€åœ¨ç»„ä»¶å¸è½½æ—¶ä¸é‡ç½®ï¼Œä½†åœ¨å¤šæ ‡ç­¾é¡µç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

### 3. **èµ„æºç«äº‰å’Œæ¸…ç†é—®é¢˜**

tsx



```
// åœ¨æ¸…ç†å‡½æ•°ä¸­å­˜åœ¨æ½œåœ¨é—®é¢˜ unlistenRefs.current.forEach((unlisten) => unlisten()); unlistenRefs.current = [];
```

å½“å¤šä¸ªä¼šè¯åŒæ—¶è¿è¡Œæ—¶ï¼š

- å¦‚æœä¸€ä¸ªä¼šè¯çš„æ¸…ç†å‡½æ•°è¢«æ‰§è¡Œï¼Œå¯èƒ½ä¼šæ„å¤–æ¸…ç†å…¶ä»–ä¼šè¯çš„ç›‘å¬å™¨
- ç¼ºä¹ä¼šè¯çº§åˆ«çš„èµ„æºéš”ç¦»æœºåˆ¶

### 4. **Tabåˆ‡æ¢æ—¶çš„çŠ¶æ€ä¿æŒé—®é¢˜**

ä»TabContextçš„å®ç°å¯ä»¥çœ‹å‡ºï¼š

- TabçŠ¶æ€é€šè¿‡`navigationHistory`ç»´æŠ¤ï¼Œä½†æ²¡æœ‰æ˜ç¡®çš„ä¼šè¯çŠ¶æ€éš”ç¦»æœºåˆ¶
- å½“ç”¨æˆ·åœ¨å¤šä¸ªä¼šè¯Tabé—´å¿«é€Ÿåˆ‡æ¢æ—¶ï¼Œå¯èƒ½å¯¼è‡´ä¼šè¯çŠ¶æ€æ··ä¹±

### 5. **è¿›ç¨‹æ³¨å†Œè¡¨å¹¶å‘è®¿é—®**

ä»`ProcessRegistry`çš„å®ç°çœ‹ï¼š

- ä½¿ç”¨äº†`Mutex<HashMap<i64, ProcessHandle>>`æ¥ä¿æŠ¤è¿›ç¨‹æ³¨å†Œè¡¨
- ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½ç“¶é¢ˆæˆ–æ­»é”é£é™©

## å…·ä½“æ”¹è¿›å»ºè®®

### 1. æ”¹è¿›äº‹ä»¶ç›‘å¬å™¨éš”ç¦»



ClaudeCodeSession.tsx



```
// ... existing code ...  // Cleanup event listeners and track mount state  useEffect(() => {    isMountedRef.current = true;    // ä¸ºæ¯ä¸ªä¼šè¯å®ä¾‹ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºç›‘å¬å™¨éš”ç¦»    const sessionInstanceKey = `${session?.id || 'new'}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;        // Reset other states to ensure clean initialization    setError(null);    setRawJsonlOutput([]);    setQueuedPrompts([]);        // é‡ç½®ç›‘å¬çŠ¶æ€ï¼Œç¡®ä¿æ¯ä¸ªä¼šè¯å®ä¾‹éƒ½æœ‰ç‹¬ç«‹çš„ç›‘å¬çŠ¶æ€    isListeningRef.current = false;        // ... existing code ...        return () => {      logger.debug("[ClaudeCodeSession] Component unmounting, cleaning up listeners for instance:", sessionInstanceKey);      isMountedRef.current = false;       // åªæ¸…ç†å½“å‰ä¼šè¯å®ä¾‹çš„ç›‘å¬å™¨      unlistenRefs.current.forEach((unlisten) => unlisten());      unlistenRefs.current = [];      isListeningRef.current = false;            // ... existing code ...    };  }, [effectiveSession, projectPath, claudeSessionId, isLoading, session?.id]); // ... existing code ...
```

### 2. å¢å¼ºä¼šè¯ç‰¹å®šç›‘å¬å™¨ç®¡ç†



ClaudeCodeSession.tsx



```
// ... existing code ...        // Helper to attach session-specific listeners **once we are sure**        const attachSessionSpecificListeners = async (sid: string) => {          logger.debug("[ClaudeCodeSession] Attaching session-specific listeners for", sid);           // æ¸…ç†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç›‘å¬          unlistenRefs.current.forEach((u) => u());          unlistenRefs.current = [];           const specificOutputUnlisten = await listen<string>(            `claude-output:${sid}`,            async (evt) => {              // å¢åŠ ä¼šè¯IDéªŒè¯ï¼Œç¡®ä¿åªå¤„ç†å½“å‰ä¼šè¯çš„æ¶ˆæ¯              if (claudeSessionId !== sid) {                logger.warn("[ClaudeCodeSession] Received message for different session, ignoring:", sid);                return;              }              await handleStreamMessage(evt.payload);            }          );           const specificErrorUnlisten = await listen<string>(`claude-error:${sid}`, async (evt) => {            if (claudeSessionId !== sid) {              logger.warn("[ClaudeCodeSession] Received error for different session, ignoring:", sid);              return;            }            await handleError(evt.payload, {              operation: "claudeErrorScoped",              source: "claude_session",            });            setError(evt.payload);          }); // ... existing code ...
```

### 3. æ·»åŠ ä¼šè¯å¹¶å‘å®‰å…¨æ£€æŸ¥



ClaudeCodeSession.tsx



```
// ... existing code ...  const handleSendPrompt = async (prompt: string, model: ClaudeModel = selectedModel) => {    // æ·»åŠ å¹¶å‘å®‰å…¨æ£€æŸ¥    if (isLoading && hasActiveSessionRef.current) {      // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ä¼šè¯åœ¨è¿è¡Œ      const activeSessions = await api.listRunningClaudeSessions();      const isCurrentSessionActive = activeSessions.some((s: any) =>         s.process_type?.ClaudeSession?.session_id === claudeSessionId      );            if (isCurrentSessionActive) {        logger.warn("[ClaudeCodeSession] Session already active, queuing prompt");        // å°†æç¤ºæ·»åŠ åˆ°é˜Ÿåˆ—è€Œä¸æ˜¯ç›´æ¥å‘é€        setQueuedPrompts(prev => [...prev, {           id: Math.random().toString(36).substr(2, 9),          prompt,           model         }]);        return;      } else {        // ä¼šè¯çŠ¶æ€ä¸åŒæ­¥ï¼Œé‡ç½®çŠ¶æ€        logger.warn("[ClaudeCodeSession] Session state out of sync, resetting");        setIsLoading(false);        hasActiveSessionRef.current = false;        isListeningRef.current = false;      }    } // ... existing code ...
```

è¿™äº›æ”¹è¿›å°†æ˜¾è‘—å¢å¼ºå¤šä¼šè¯å¹¶å‘äº¤äº’çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œä¸»è¦è§£å†³äº†ï¼š

1. **ç›‘å¬å™¨éš”ç¦»**ï¼šç¡®ä¿æ¯ä¸ªä¼šè¯å®ä¾‹æœ‰ç‹¬ç«‹çš„ç›‘å¬å™¨ç®¡ç†
2. **ä¼šè¯IDéªŒè¯**ï¼šåœ¨å¤„ç†æ¶ˆæ¯æ—¶éªŒè¯ä¼šè¯IDï¼Œé˜²æ­¢æ¶ˆæ¯é”™å‘
3. **å¹¶å‘å®‰å…¨æ£€æŸ¥**ï¼šåœ¨å‘é€æ–°æç¤ºå‰æ£€æŸ¥ä¼šè¯çŠ¶æ€ï¼Œé¿å…å†²çª
4. **çŠ¶æ€åŒæ­¥**ï¼šå¢å¼ºä¼šè¯çŠ¶æ€çš„åŒæ­¥æœºåˆ¶ï¼Œé˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´

é€šè¿‡è¿™äº›ä¿®æ”¹ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…åœ¨å¤šä¼šè¯å¹¶å‘äº¤äº’æ—¶å‡ºç°çš„æ¶ˆæ¯æ··ä¹±ã€çŠ¶æ€é”™ä¹±å’Œèµ„æºç«äº‰ç­‰é—®é¢˜ã€‚

---

## ğŸ” **æ·±åº¦ä»£ç åˆ†æå‘ç°çš„é¢å¤–é—®é¢˜**

### **é—®é¢˜ 9: useClaudeMessages Hook çš„çŠ¶æ€éš”ç¦»ä¸è¶³**

**ä½ç½®**: `src/components/claude-code-session/useClaudeMessages.ts`

**é—®é¢˜æè¿°**:
```typescript
// å½“å‰å®ç°ä½¿ç”¨å•ä¸€çš„å…¨å±€äº‹ä»¶ç›‘å¬å™¨
eventListenerRef.current = await listen<string>("claude-stream", (event) => {
  // æ‰€æœ‰ä¼šè¯å…±äº«åŒä¸€ä¸ªäº‹ä»¶é€šé“
});
```

**å½±å“**:
- å¤šä¸ª `ClaudeCodeSession` ç»„ä»¶å®ä¾‹ä¼šå…±äº«åŒä¸€ä¸ª `claude-stream` äº‹ä»¶
- æ— æ³•åŒºåˆ†æ¶ˆæ¯æ¥è‡ªå“ªä¸ªä¼šè¯
- å¯¼è‡´æ¶ˆæ¯ä¸²æµåˆ°é”™è¯¯çš„ä¼šè¯

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨ä¼šè¯ç‰¹å®šçš„äº‹ä»¶é€šé“
eventListenerRef.current = await listen<string>(
  `claude-stream:${sessionId}`, 
  (event) => {
    // åªå¤„ç†å½“å‰ä¼šè¯çš„æ¶ˆæ¯
  }
);
```

### **é—®é¢˜ 10: Tab åˆ‡æ¢æ—¶çš„ä¼šè¯çŠ¶æ€ä¸ä¿å­˜**

**ä½ç½®**: `src/contexts/TabContext.tsx`

**é—®é¢˜æè¿°**:
```typescript
// Tab åˆ‡æ¢æ—¶ï¼ŒClaudeCodeSession ç»„ä»¶ä¼šå¸è½½
const removeTab = useCallback((id: string) => {
  // ç»„ä»¶å¸è½½ï¼Œæ‰€æœ‰ useState çŠ¶æ€ä¸¢å¤±
  const filteredTabs = currentTabs.filter((tab) => tab.id !== id);
});
```

**å½±å“**:
- ç”¨æˆ·åˆ‡æ¢ Tab åï¼ŒåŸ Tab çš„ä¼šè¯çŠ¶æ€å®Œå…¨ä¸¢å¤±
- æ¶ˆæ¯å†å²ã€è¾“å…¥æ¡†å†…å®¹ã€æ»šåŠ¨ä½ç½®ç­‰å…¨éƒ¨é‡ç½®
- ç”¨æˆ·ä½“éªŒæå·®

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ Tab æ•°æ®ä¸­ä¿å­˜ä¼šè¯çŠ¶æ€
interface Tab {
  // ... ç°æœ‰å­—æ®µ
  sessionState?: {
    messages: ClaudeStreamMessage[];
    scrollPosition: number;
    inputValue: string;
    isStreaming: boolean;
  };
}

// Tab åˆ‡æ¢æ—¶ä¿å­˜çŠ¶æ€
const updateTab = useCallback((id: string, updates: Partial<Tab>) => {
  setTabs((prevTabs) =>
    prevTabs.map((tab) => {
      if (tab.id === id) {
        return { 
          ...tab, 
          ...updates, 
          sessionState: {
            ...tab.sessionState,
            ...updates.sessionState
          },
          updatedAt: new Date() 
        };
      }
      return tab;
    })
  );
}, []);
```

### **é—®é¢˜ 11: sessionStore çš„çŠ¶æ€ä¸ç»„ä»¶çŠ¶æ€ä¸åŒæ­¥**

**ä½ç½®**: `src/stores/sessionStore.ts` å’Œ `ClaudeCodeSession.tsx`

**é—®é¢˜æè¿°**:
- `sessionStore` ä½¿ç”¨ Zustand ç®¡ç†å…¨å±€çŠ¶æ€
- `ClaudeCodeSession` ä½¿ç”¨ `useState` ç®¡ç†æœ¬åœ°çŠ¶æ€
- ä¸¤è€…ä¹‹é—´æ²¡æœ‰åŒæ­¥æœºåˆ¶

**å½±å“**:
```typescript
// sessionStore ä¸­çš„æ•°æ®
currentSessionId: "session-123"

// ClaudeCodeSession ç»„ä»¶ä¸­çš„æ•°æ®
const [claudeSessionId, setClaudeSessionId] = useState<string | null>(null);

// ä¸¤è€…å¯èƒ½ä¸ä¸€è‡´ï¼Œå¯¼è‡´çŠ¶æ€æ··ä¹±
```

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ ClaudeCodeSession ä¸­ä½¿ç”¨ sessionStore
import { useSessionStore } from '@/stores/sessionStore';

export const ClaudeCodeSession: React.FC<ClaudeCodeSessionProps> = ({
  session,
  // ...
}) => {
  // ä½¿ç”¨å…¨å±€çŠ¶æ€è€Œéæœ¬åœ°çŠ¶æ€
  const { 
    currentSessionId, 
    setCurrentSession,
    sessionOutputs,
    handleOutputUpdate 
  } = useSessionStore();
  
  // ä¸å†ä½¿ç”¨ useState
  // const [claudeSessionId, setClaudeSessionId] = useState<string | null>(null);
};
```

### **é—®é¢˜ 12: äº‹ä»¶ç›‘å¬å™¨æ³„æ¼**

**ä½ç½®**: `ClaudeCodeSession.tsx` çš„ `useEffect` æ¸…ç†å‡½æ•°

**é—®é¢˜æè¿°**:
```typescript
useEffect(() => {
  // è®¾ç½®ç›‘å¬å™¨
  const setupListeners = async () => {
    unlistenRefs.current.push(await listen("claude-output", handler));
  };
  
  return () => {
    // æ¸…ç†ç›‘å¬å™¨
    unlistenRefs.current.forEach((unlisten) => unlisten());
    unlistenRefs.current = [];
  };
}, [effectiveSession, projectPath, claudeSessionId, isLoading, session?.id]);
```

**å½±å“**:
- ä¾èµ–é¡¹å˜åŒ–é¢‘ç¹ï¼Œå¯¼è‡´ç›‘å¬å™¨é¢‘ç¹åˆ›å»ºå’Œé”€æ¯
- å¯èƒ½åœ¨å¼‚æ­¥æ“ä½œå®Œæˆå‰å°±æ‰§è¡Œæ¸…ç†ï¼Œå¯¼è‡´ç›‘å¬å™¨æ³„æ¼
- å†…å­˜å ç”¨æŒç»­å¢é•¿

**è§£å†³æ–¹æ¡ˆ**:
```typescript
useEffect(() => {
  let isCancelled = false;
  const listeners: UnlistenFn[] = [];
  
  const setupListeners = async () => {
    if (isCancelled) return;
    
    const unlisten = await listen("claude-output", handler);
    if (!isCancelled) {
      listeners.push(unlisten);
    } else {
      // å¦‚æœå·²å–æ¶ˆï¼Œç«‹å³æ¸…ç†
      unlisten();
    }
  };
  
  setupListeners();
  
  return () => {
    isCancelled = true;
    listeners.forEach((unlisten) => unlisten());
  };
}, [claudeSessionId]); // å‡å°‘ä¾èµ–é¡¹ï¼Œåªåœ¨ä¼šè¯IDå˜åŒ–æ—¶é‡æ–°è®¾ç½®
```

### **é—®é¢˜ 13: loadSessionHistory çš„ç«æ€æ¡ä»¶**

**ä½ç½®**: `ClaudeCodeSession.tsx:681-747`

**é—®é¢˜æè¿°**:
```typescript
const loadSessionHistory = useCallback(async () => {
  if (!session?.id) {
    setMessages([]);
    return;
  }
  
  setIsLoading(true);
  
  try {
    // å¼‚æ­¥åŠ è½½å†å²
    const historyMessages = await api.loadSessionHistory(session.id, session.project_id);
    
    // é—®é¢˜ï¼šå¦‚æœåœ¨åŠ è½½æœŸé—´ session.id å˜åŒ–äº†ï¼Œä¼šè®¾ç½®é”™è¯¯çš„æ¶ˆæ¯
    if (isMountedRef.current) {
      setMessages(parsedMessages);
    }
  } finally {
    setIsLoading(false);
  }
}, [session?.id, session?.project_id]);
```

**å½±å“**:
- å¿«é€Ÿåˆ‡æ¢ä¼šè¯æ—¶ï¼Œå¯èƒ½æ˜¾ç¤ºé”™è¯¯ä¼šè¯çš„å†å²æ¶ˆæ¯
- å¯¼è‡´ç”¨æˆ·çœ‹åˆ°æ··ä¹±çš„æ¶ˆæ¯æµ

**è§£å†³æ–¹æ¡ˆ**:
```typescript
const loadSessionHistory = useCallback(async () => {
  if (!session?.id) {
    setMessages([]);
    return;
  }
  
  const currentSessionId = session.id; // æ•è·å½“å‰ä¼šè¯ID
  setIsLoading(true);
  
  try {
    const historyMessages = await api.loadSessionHistory(session.id, session.project_id);
    
    // éªŒè¯ä¼šè¯IDæ˜¯å¦ä»ç„¶åŒ¹é…
    if (isMountedRef.current && session?.id === currentSessionId) {
      setMessages(parsedMessages);
    } else {
      logger.warn(`Session changed during history load, discarding results for ${currentSessionId}`);
    }
  } finally {
    if (session?.id === currentSessionId) {
      setIsLoading(false);
    }
  }
}, [session?.id, session?.project_id]);
```

### **é—®é¢˜ 14: æ¶ˆæ¯å»é‡é€»è¾‘è¿‡äºå¤æ‚ä¸”ä¸å¯é **

**ä½ç½®**: `ClaudeCodeSession.tsx` çš„ `displayableMessages` useMemo

**é—®é¢˜æè¿°**:
- ä½¿ç”¨å¤æ‚çš„æ–‡æœ¬ç›¸ä¼¼åº¦ç®—æ³•æ¥å»é‡æ¶ˆæ¯
- ä¾èµ–å¤šå±‚åµŒå¥—å¾ªç¯å’Œå­—ç¬¦ä¸²æ¯”è¾ƒ
- æ€§èƒ½å·®ä¸”å®¹æ˜“è¯¯åˆ¤

**å½±å“**:
```typescript
// å½“å‰å®ç°
const similarity = (str1: string, str2: string): number => {
  // å¤æ‚çš„ç›¸ä¼¼åº¦è®¡ç®—
  // å¯èƒ½è¯¯åˆ¤æ­£å¸¸æ¶ˆæ¯ä¸ºé‡å¤
};

// å¯èƒ½å¯¼è‡´é‡è¦æ¶ˆæ¯è¢«è¿‡æ»¤æ‰
if (similarity(assistantText, resultText) > 0.85) {
  return false; // è¿‡æ»¤æ¶ˆæ¯
}
```

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨æ¶ˆæ¯IDå’Œç±»å‹æ¥å»é‡ï¼Œè€Œéå†…å®¹æ¯”è¾ƒ
const displayableMessages = useMemo(() => {
  const seen = new Set<string>();
  
  return messages.filter((message, index) => {
    // ä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆå”¯ä¸€æ ‡è¯†
    const messageKey = `${message.type}-${message.timestamp || index}-${message.message?.id || ''}`;
    
    if (seen.has(messageKey)) {
      return false; // çœŸæ­£çš„é‡å¤æ¶ˆæ¯
    }
    
    seen.add(messageKey);
    return true;
  });
}, [messages]);
```

---

## è§£å†³æ–¹æ¡ˆæ±‡æ€»

### **ç«‹å³ä¿®å¤ï¼ˆP0 - ä¸¥é‡å½±å“åŠŸèƒ½ï¼‰**

1. âœ… **ä¿®å¤ Claude Session è¿›ç¨‹æ¸…ç† Bug**
   - å®ç° `is_claude_session_running` ä¸“ç”¨æ£€æŸ¥
   - é¿å…è¯¯åˆ é™¤æ´»è·ƒä¼šè¯

2. âœ… **å®ç°ä¼šè¯çŠ¶æ€æŒä¹…åŒ–**
   - ä½¿ç”¨ localStorage ä¿å­˜ä¼šè¯çŠ¶æ€
   - ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶æ¢å¤çŠ¶æ€

3. âœ… **ä¿®å¤äº‹ä»¶ç›‘å¬å™¨éš”ç¦»**
   - ä½¿ç”¨ä¼šè¯ç‰¹å®šçš„äº‹ä»¶é€šé“
   - é¿å…æ¶ˆæ¯ä¸²æµ

4. âœ… **ä¿®å¤ JSONL æ–‡ä»¶å¹¶å‘è®¿é—®**
   - å®ç°æ–‡ä»¶é”æœºåˆ¶
   - é¿å…è¯»å†™å†²çª

### **é«˜ä¼˜å…ˆçº§ä¿®å¤ï¼ˆP1 - å½±å“ç¨³å®šæ€§ï¼‰**

5. âœ… **ç»Ÿä¸€çŠ¶æ€ç®¡ç†**
   - å°†ç»„ä»¶çŠ¶æ€è¿ç§»åˆ° sessionStore
   - æ¶ˆé™¤çŠ¶æ€ä¸åŒæ­¥é—®é¢˜

6. âœ… **ä¿®å¤ Tab åˆ‡æ¢çŠ¶æ€ä¸¢å¤±**
   - åœ¨ Tab æ•°æ®ä¸­ä¿å­˜ä¼šè¯çŠ¶æ€
   - åˆ‡æ¢æ—¶ä¿ç•™ç”¨æˆ·ä¸Šä¸‹æ–‡

7. âœ… **ä¿®å¤äº‹ä»¶ç›‘å¬å™¨æ³„æ¼**
   - ä¼˜åŒ– useEffect ä¾èµ–é¡¹
   - å®ç°æ­£ç¡®çš„æ¸…ç†é€»è¾‘

8. âœ… **ä¿®å¤ loadSessionHistory ç«æ€æ¡ä»¶**
   - æ·»åŠ ä¼šè¯IDéªŒè¯
   - é¿å…æ˜¾ç¤ºé”™è¯¯ä¼šè¯çš„æ¶ˆæ¯

### **ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆP2 - æ”¹å–„ä½“éªŒï¼‰**

9. âš ï¸ **ä¼˜åŒ–æ¶ˆæ¯å»é‡é€»è¾‘**
   - ä½¿ç”¨æ¶ˆæ¯IDè€Œéå†…å®¹æ¯”è¾ƒ
   - æå‡æ€§èƒ½å’Œå‡†ç¡®æ€§

10. âš ï¸ **é™åˆ¶ live_output ç¼“å†²åŒºå¤§å°**
    - é˜²æ­¢å†…å­˜æ³„æ¼
    - é¿å…é•¿æ—¶é—´å¯¹è¯å´©æºƒ

11. âš ï¸ **ç»Ÿä¸€æ¨¡å‹é…ç½®æ¥æº**
    - ä½¿ç”¨å•ä¸€å¯ä¿¡æ¥æº
    - é¿å…é…ç½®ä¸ä¸€è‡´

### **ä½ä¼˜å…ˆçº§æ”¹è¿›ï¼ˆP3 - è¾¹ç¼˜æƒ…å†µï¼‰**

12. ğŸ“ **å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•**
    - å®ç°æŒ‡æ•°é€€é¿é‡è¯•
    - æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

13. ğŸ“ **æ·»åŠ è¯¦ç»†æ—¥å¿—å’Œç›‘æ§**
    - è¿½è¸ªä¼šè¯çŠ¶æ€å˜åŒ–
    - ä¾¿äºé—®é¢˜æ’æŸ¥

---

## å®æ–½ä¼˜å…ˆçº§

### **ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰**
- ä¿®å¤è¿›ç¨‹æ¸…ç† Bug
- å®ç°ä¼šè¯çŠ¶æ€æŒä¹…åŒ–
- ä¿®å¤äº‹ä»¶ç›‘å¬å™¨éš”ç¦»
- ä¿®å¤æ–‡ä»¶å¹¶å‘è®¿é—®

### **ç¬¬äºŒé˜¶æ®µï¼šç¨³å®šæ€§æå‡ï¼ˆ3-5å¤©ï¼‰**
- ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- ä¿®å¤ Tab åˆ‡æ¢é—®é¢˜
- ä¿®å¤ç›‘å¬å™¨æ³„æ¼
- ä¿®å¤ç«æ€æ¡ä»¶

### **ç¬¬ä¸‰é˜¶æ®µï¼šä½“éªŒä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰**
- ä¼˜åŒ–æ¶ˆæ¯å»é‡
- é™åˆ¶ç¼“å†²åŒºå¤§å°
- ç»Ÿä¸€é…ç½®ç®¡ç†
- å¢å¼ºé”™è¯¯å¤„ç†

---

## éªŒè¯æ¸…å•

### **å•ä¼šè¯æµ‹è¯•**
- [ ] åˆ·æ–°é¡µé¢åä¼šè¯çŠ¶æ€ä¿æŒ
- [ ] é•¿æ—¶é—´å¯¹è¯ä¸å´©æºƒ
- [ ] æ¶ˆæ¯é¡ºåºæ­£ç¡®
- [ ] æ–‡ä»¶è¯»å†™æ— å†²çª

### **å¤šä¼šè¯æµ‹è¯•**
- [ ] åŒæ—¶è¿è¡Œ3ä¸ªä¼šè¯æ— ä¸²æµ
- [ ] å¿«é€Ÿåˆ‡æ¢Tabæ— çŠ¶æ€ä¸¢å¤±
- [ ] å…³é—­ä¼šè¯æ­£ç¡®æ¸…ç†èµ„æº
- [ ] å¹¶å‘å‘é€æ¶ˆæ¯æ— å†²çª

### **è¾¹ç¼˜æƒ…å†µæµ‹è¯•**
- [ ] ç½‘ç»œä¸­æ–­åæ¢å¤
- [ ] è¿›ç¨‹æ„å¤–ç»ˆæ­¢åæ¢å¤
- [ ] ç£ç›˜ç©ºé—´ä¸è¶³æ—¶çš„å¤„ç†
- [ ] è¶…å¤§æ¶ˆæ¯çš„å¤„ç†

---

## ğŸ” æœ€ç»ˆå®¡æŸ¥ç»“è®ºä¸ä¿®æ­£

### **ä»£ç å®¡æŸ¥éªŒè¯ç»“æœ**

ç»è¿‡æ·±å…¥çš„ä»£ç å®¡æŸ¥å’Œäº¤å‰éªŒè¯ï¼Œå¯¹åŸå§‹åˆ†æè¿›è¡Œäº†ä»¥ä¸‹ä¿®æ­£ï¼š

#### âœ… **ç¡®è®¤å­˜åœ¨çš„é—®é¢˜**

1. **Tab åˆ‡æ¢çŠ¶æ€ä¸¢å¤±ï¼ˆé—®é¢˜10ï¼‰** - **å½±å“æœ€ä¸¥é‡**
   - `TabContext` æ²¡æœ‰ä¿å­˜ä¼šè¯çŠ¶æ€
   - ç”¨æˆ·æ¯æ¬¡åˆ‡æ¢ Tab éƒ½ä¼šä¸¢å¤±æ‰€æœ‰æ¶ˆæ¯ã€è¾“å…¥å†…å®¹ã€æ»šåŠ¨ä½ç½®
   - **è¿™æ˜¯ç”¨æˆ·ä½“éªŒæœ€å·®çš„é—®é¢˜**

2. **React ç»„ä»¶çŠ¶æ€é‡ç½®** - ç¡®è®¤å­˜åœ¨
   - `ClaudeCodeSession` ä½¿ç”¨ `useState` ç®¡ç†çŠ¶æ€
   - åˆ·æ–°é¡µé¢æˆ–ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶çŠ¶æ€ä¸¢å¤±

3. **loadSessionHistory ç«æ€æ¡ä»¶ï¼ˆé—®é¢˜13ï¼‰** - ç¡®è®¤å­˜åœ¨
   - å¿«é€Ÿåˆ‡æ¢ä¼šè¯æ—¶å¯èƒ½æ˜¾ç¤ºé”™è¯¯ä¼šè¯çš„æ¶ˆæ¯
   - ç¼ºå°‘ä¼šè¯IDéªŒè¯æœºåˆ¶

4. **è¿›ç¨‹æ¸…ç† Bugï¼ˆé—®é¢˜1ï¼‰** - ä»£ç ç¼ºé™·å­˜åœ¨ï¼Œä½†å½±å“å¾…ç¡®è®¤
   - `registry.rs` ä¸­ Claude Session çš„ `child handle` ç¡®å®è®¾ä¸º `None`
   - **ä½†æœç´¢ä»£ç æœªæ‰¾åˆ° `cleanup_finished_processes` çš„è°ƒç”¨**
   - **å»ºè®®**ï¼šå…ˆæ·»åŠ æ—¥å¿—ç›‘æ§ï¼Œç¡®è®¤æ˜¯å¦çœŸçš„é€ æˆå½±å“

5. **äº‹ä»¶ç›‘å¬å™¨ä¾èµ–é¡¹è¿‡å¤šï¼ˆé—®é¢˜12ï¼‰** - ç¡®è®¤å­˜åœ¨
   - `useEffect` ä¾èµ–é¡¹åŒ…å« `effectiveSession, projectPath, claudeSessionId, isLoading, session?.id`
   - å¯¼è‡´ç›‘å¬å™¨é¢‘ç¹é‡å»ºï¼Œå¯èƒ½é€ æˆæ€§èƒ½é—®é¢˜

#### âš ï¸ **éœ€è¦ä¿®æ­£çš„åˆ†æ**

1. **é—®é¢˜9ï¼šuseClaudeMessages çš„çŠ¶æ€éš”ç¦»** - **ä¸å­˜åœ¨æˆ–å½±å“æå°**
   - **å®é™…æƒ…å†µ**ï¼š`ClaudeCodeSession` **å·²ç»ä½¿ç”¨**ä¼šè¯ç‰¹å®šçš„äº‹ä»¶é€šé“
   - ä»£ç ä¸­ä½¿ç”¨ `listen<string>(\`claude-output:${session.id}\`, ...)`
   - `useClaudeMessages` Hook è™½ç„¶ä½¿ç”¨é€šç”¨äº‹ä»¶ï¼Œä½†**æœªè¢« ClaudeCodeSession ä½¿ç”¨**
   - **ç»“è®º**ï¼šå¯ä»¥è·³è¿‡æ­¤é—®é¢˜

2. **é—®é¢˜1çš„ä¸¥é‡æ€§** - **éœ€è¦é™çº§**
   - è™½ç„¶ä»£ç æœ‰ç¼ºé™·ï¼Œä½†æœªæ‰¾åˆ°è°ƒç”¨ç‚¹
   - å»ºè®®å…ˆç›‘æ§ï¼Œå†å†³å®šæ˜¯å¦ä¿®å¤

#### ğŸ“Š **é—®é¢˜å½±å“è¯„ä¼°çŸ©é˜µ**

| é—®é¢˜ | å½±å“èŒƒå›´ | ç”¨æˆ·æ„ŸçŸ¥ | ä¿®å¤éš¾åº¦ | ä¼˜å…ˆçº§ |
|------|---------|---------|---------|--------|
| Tabåˆ‡æ¢çŠ¶æ€ä¸¢å¤± | é«˜ | æé«˜ | ä¸­ | **P0** |
| çŠ¶æ€æŒä¹…åŒ–ç¼ºå¤± | é«˜ | é«˜ | ä½ | **P0** |
| ç«æ€æ¡ä»¶ | ä¸­ | é«˜ | ä½ | **P0** |
| è¿›ç¨‹æ¸…ç†Bug | æœªçŸ¥ | æœªçŸ¥ | ä¸­ | **P1** |
| æ–‡ä»¶å¹¶å‘è®¿é—® | ä¸­ | ä¸­ | ä¸­ | **P1** |
| ç›‘å¬å™¨æ³„æ¼ | ä½ | ä½ | ä½ | **P1** |
| æ¶ˆæ¯å»é‡ | ä½ | ä¸­ | ä¸­ | **P2** |
| å†…å­˜æ³„æ¼ | ä½ | ä½ | ä½ | **P2** |

---

## ğŸ“‹ ä¿®æ­£åçš„å®æ–½è®¡åˆ’

### **ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰** âš¡

**ç›®æ ‡**ï¼šè§£å†³ç”¨æˆ·ä½“éªŒæœ€å·®çš„é—®é¢˜

1. **ä¿®å¤ Tab åˆ‡æ¢çŠ¶æ€ä¸¢å¤±**ï¼ˆé—®é¢˜10ï¼‰
   ```typescript
   // åœ¨ Tab æ¥å£ä¸­æ·»åŠ ä¼šè¯çŠ¶æ€
   interface Tab {
     sessionState?: {
       messages: ClaudeStreamMessage[];
       scrollPosition: number;
       inputValue: string;
       isStreaming: boolean;
       claudeSessionId: string | null;
     };
   }
   ```
   - **éªŒè¯æ–¹æ³•**ï¼šåˆ‡æ¢ Tab åæ¶ˆæ¯å’Œè¾“å…¥å†…å®¹ä¿æŒä¸å˜
   - **é¢„æœŸæ•ˆæœ**ï¼šç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

2. **å®ç°ä¼šè¯çŠ¶æ€æŒä¹…åŒ–**
   ```typescript
   // ä½¿ç”¨ localStorage ä¿å­˜å…³é”®çŠ¶æ€
   useEffect(() => {
     if (claudeSessionId) {
       localStorage.setItem(`session_${claudeSessionId}`, JSON.stringify({
         messages,
         projectPath,
         timestamp: Date.now()
       }));
     }
   }, [claudeSessionId, messages, projectPath]);
   ```
   - **éªŒè¯æ–¹æ³•**ï¼šåˆ·æ–°é¡µé¢åä¼šè¯çŠ¶æ€æ¢å¤
   - **é¢„æœŸæ•ˆæœ**ï¼šé¿å…æ„å¤–åˆ·æ–°å¯¼è‡´çš„æ•°æ®ä¸¢å¤±

3. **ä¿®å¤ loadSessionHistory ç«æ€æ¡ä»¶**ï¼ˆé—®é¢˜13ï¼‰
   ```typescript
   const loadSessionHistory = useCallback(async () => {
     const currentSessionId = session.id; // æ•è·å½“å‰ID
     
     const historyMessages = await api.loadSessionHistory(session.id, session.project_id);
     
     // éªŒè¯ä¼šè¯IDæ˜¯å¦ä»ç„¶åŒ¹é…
     if (session?.id === currentSessionId) {
       setMessages(parsedMessages);
     } else {
       logger.warn(`Session changed, discarding results for ${currentSessionId}`);
     }
   }, [session?.id, session?.project_id]);
   ```
   - **éªŒè¯æ–¹æ³•**ï¼šå¿«é€Ÿåˆ‡æ¢ä¼šè¯ä¸ä¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
   - **é¢„æœŸæ•ˆæœ**ï¼šæ¶ˆæ¯æµå§‹ç»ˆæ­£ç¡®

### **ç¬¬äºŒé˜¶æ®µï¼šç¨³å®šæ€§æå‡ï¼ˆ2-3å¤©ï¼‰** ğŸ›¡ï¸

**ç›®æ ‡**ï¼šæå‡ç³»ç»Ÿç¨³å®šæ€§å’Œå¯é æ€§

4. **ç›‘æ§è¿›ç¨‹æ¸…ç† Bug**ï¼ˆé—®é¢˜1ï¼‰
   ```rust
   // å…ˆæ·»åŠ è¯¦ç»†æ—¥å¿—
   pub fn cleanup_finished_processes(&self) -> Result<Vec<i64>, String> {
       log::info!("Starting cleanup_finished_processes");
       // ... ç°æœ‰é€»è¾‘
       log::info!("Cleaned up {} processes", finished_runs.len());
   }
   ```
   - **éªŒè¯æ–¹æ³•**ï¼šè¿è¡Œä¸€å‘¨ï¼Œè§‚å¯Ÿæ—¥å¿—ä¸­æ˜¯å¦æœ‰è¯¯åˆ é™¤
   - **å†³ç­–ç‚¹**ï¼šå¦‚æœå‘ç°é—®é¢˜ï¼Œå†å®æ–½ä¿®å¤

5. **å®ç°æ–‡ä»¶å¹¶å‘è®¿é—®æ§åˆ¶**ï¼ˆé—®é¢˜2ï¼‰
   ```rust
   use fs2::FileExt;
   
   let file = fs::File::open(&session_path)?;
   file.lock_shared()?; // è¯»å–æ—¶å…±äº«é”
   // ... è¯»å–æ“ä½œ
   file.unlock()?;
   ```
   - **éªŒè¯æ–¹æ³•**ï¼šå¹¶å‘è¯»å†™æµ‹è¯•ä¸å‡ºç°è§£æé”™è¯¯
   - **é¢„æœŸæ•ˆæœ**ï¼šWindows ç¯å¢ƒä¸‹æ›´ç¨³å®š

6. **ä¼˜åŒ–äº‹ä»¶ç›‘å¬å™¨ä¾èµ–é¡¹**ï¼ˆé—®é¢˜12ï¼‰
   ```typescript
   useEffect(() => {
     // åªåœ¨ claudeSessionId å˜åŒ–æ—¶é‡å»ºç›‘å¬å™¨
     // ç§»é™¤ä¸å¿…è¦çš„ä¾èµ–é¡¹
   }, [claudeSessionId]); // ç®€åŒ–ä¾èµ–
   ```
   - **éªŒè¯æ–¹æ³•**ï¼šç›‘å¬å™¨åˆ›å»ºæ¬¡æ•°æ˜¾è‘—å‡å°‘
   - **é¢„æœŸæ•ˆæœ**ï¼šæ€§èƒ½æå‡ï¼Œå†…å­˜å ç”¨é™ä½

### **ç¬¬ä¸‰é˜¶æ®µï¼šä½“éªŒä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰** âœ¨

**ç›®æ ‡**ï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½

7. **ä¼˜åŒ–æ¶ˆæ¯å»é‡é€»è¾‘**ï¼ˆé—®é¢˜14ï¼‰
   ```typescript
   // ä½¿ç”¨æ¶ˆæ¯IDè€Œéå†…å®¹æ¯”è¾ƒ
   const displayableMessages = useMemo(() => {
     const seen = new Set<string>();
     return messages.filter((message, index) => {
       const messageKey = `${message.type}-${message.timestamp || index}-${message.message?.id || ''}`;
       if (seen.has(messageKey)) return false;
       seen.add(messageKey);
       return true;
     });
   }, [messages]);
   ```

8. **é™åˆ¶ live_output ç¼“å†²åŒºå¤§å°**ï¼ˆé—®é¢˜4ï¼‰
   ```rust
   const MAX_OUTPUT_SIZE: usize = 10 * 1024 * 1024; // 10MB
   if live_output.len() > MAX_OUTPUT_SIZE {
       *live_output = live_output.split_off(MAX_OUTPUT_SIZE / 2);
   }
   ```

9. **ç»Ÿä¸€æ¨¡å‹é…ç½®ç®¡ç†**ï¼ˆé—®é¢˜5ã€11ï¼‰
   - ä½¿ç”¨ sessionStore ä½œä¸ºå•ä¸€æ•°æ®æº
   - localStorage å’Œæ•°æ®åº“ä½œä¸ºæŒä¹…åŒ–å±‚

---

## âœ… éªŒè¯æ¸…å•ï¼ˆæ›´æ–°ç‰ˆï¼‰

### **ç¬¬ä¸€é˜¶æ®µéªŒè¯**
- [ ] åˆ‡æ¢ Tab åæ¶ˆæ¯å†å²ä¿æŒ
- [ ] åˆ‡æ¢ Tab åè¾“å…¥æ¡†å†…å®¹ä¿æŒ
- [ ] åˆ‡æ¢ Tab åæ»šåŠ¨ä½ç½®ä¿æŒ
- [ ] åˆ·æ–°é¡µé¢åä¼šè¯çŠ¶æ€æ¢å¤
- [ ] å¿«é€Ÿåˆ‡æ¢ä¼šè¯ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†è¿›å…¥ç¬¬äºŒé˜¶æ®µ

### **ç¬¬äºŒé˜¶æ®µéªŒè¯**
- [ ] è¿è¡Œä¸€å‘¨æ— è¿›ç¨‹è¯¯åˆ é™¤æ—¥å¿—
- [ ] å¹¶å‘è¯»å†™æ–‡ä»¶æ— è§£æé”™è¯¯
- [ ] ç›‘å¬å™¨åˆ›å»ºæ¬¡æ•°å‡å°‘ 50% ä»¥ä¸Š
- [ ] å†…å­˜å ç”¨ç¨³å®š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†è¿›å…¥ç¬¬ä¸‰é˜¶æ®µ

### **ç¬¬ä¸‰é˜¶æ®µéªŒè¯**
- [ ] æ¶ˆæ¯å»é‡å‡†ç¡®ç‡ 100%
- [ ] é•¿æ—¶é—´å¯¹è¯ï¼ˆ1å°æ—¶+ï¼‰ä¸å´©æºƒ
- [ ] å†…å­˜å ç”¨ä¸è¶…è¿‡ 500MB
- [ ] æ¨¡å‹é…ç½®å§‹ç»ˆä¸€è‡´

### **å›å½’æµ‹è¯•**
- [ ] å•ä¼šè¯ï¼šåˆ·æ–°é¡µé¢åçŠ¶æ€ä¿æŒ
- [ ] å•ä¼šè¯ï¼šé•¿æ—¶é—´å¯¹è¯ä¸å´©æºƒ
- [ ] å¤šä¼šè¯ï¼šåŒæ—¶è¿è¡Œ3ä¸ªä¼šè¯æ— ä¸²æµ
- [ ] å¤šä¼šè¯ï¼šå¿«é€Ÿåˆ‡æ¢Tabæ— çŠ¶æ€ä¸¢å¤±
- [ ] è¾¹ç¼˜æƒ…å†µï¼šç½‘ç»œä¸­æ–­åæ¢å¤
- [ ] è¾¹ç¼˜æƒ…å†µï¼šè¿›ç¨‹æ„å¤–ç»ˆæ­¢åæ¢å¤

---

## æ€»ç»“

ç»è¿‡æ·±å…¥çš„ä»£ç å®¡æŸ¥å’Œäº¤å‰éªŒè¯ï¼Œæˆ‘å‘ç° termiClaude é¡¹ç›®åœ¨ä¼šè¯ç®¡ç†æ–¹é¢å­˜åœ¨ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

### **æ ¸å¿ƒé—®é¢˜ï¼ˆæŒ‰å½±å“æ’åºï¼‰**

1. **ç”Ÿå‘½å‘¨æœŸå±‚é¢**ï¼šTab åˆ‡æ¢æ—¶çŠ¶æ€ä¸¢å¤±ï¼Œ**ç”¨æˆ·ä½“éªŒæœ€å·®**ï¼ˆP0ï¼‰
2. **çŠ¶æ€ç®¡ç†å±‚é¢**ï¼šç»„ä»¶çŠ¶æ€æœªæŒä¹…åŒ–ï¼Œåˆ·æ–°é¡µé¢ä¸¢å¤±æ•°æ®ï¼ˆP0ï¼‰
3. **å¹¶å‘å±‚é¢**ï¼šç«æ€æ¡ä»¶å¯¼è‡´æ¶ˆæ¯æ··ä¹±ï¼ˆP0ï¼‰
4. **è¿›ç¨‹ç®¡ç†å±‚é¢**ï¼šè¿›ç¨‹æ¸…ç†é€»è¾‘æœ‰ç¼ºé™·ï¼Œä½†å½±å“å¾…ç¡®è®¤ï¼ˆP1ï¼‰
5. **æ–‡ä»¶ç³»ç»Ÿå±‚é¢**ï¼šå¹¶å‘è®¿é—®å¯èƒ½å¯¼è‡´æ•°æ®æŸåï¼ˆP1ï¼‰

### **æ–‡æ¡£åˆ†æçš„æ­£ç¡®æ€§è¯„ä¼°**

- âœ… **85% æ­£ç¡®**ï¼šä¸»è¦é—®é¢˜è¯†åˆ«å‡†ç¡®
- âœ… çŠ¶æ€æŒä¹…åŒ–å’Œç«æ€æ¡ä»¶çš„è§£å†³æ–¹æ¡ˆå¯è¡Œ
- âš ï¸ **ä¼˜å…ˆçº§éœ€è¦è°ƒæ•´**ï¼šTab åˆ‡æ¢é—®é¢˜å½±å“æœ€å¤§ï¼Œåº”ä¼˜å…ˆä¿®å¤
- âš ï¸ **é—®é¢˜9ä¸å­˜åœ¨**ï¼šClaudeCodeSession å·²ä½¿ç”¨ä¼šè¯ç‰¹å®šäº‹ä»¶é€šé“
- âš ï¸ **é—®é¢˜1éœ€è¦éªŒè¯**ï¼šå…ˆç›‘æ§å†å†³å®šæ˜¯å¦ä¿®å¤

### **å®æ–½å»ºè®®**

1. **ä¸¥æ ¼æŒ‰ç…§ä¸‰é˜¶æ®µæ‰§è¡Œ**ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆå¹¶éªŒè¯åå†è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
2. **ä¼˜å…ˆä¿®å¤ç”¨æˆ·æ„ŸçŸ¥æœ€å¼ºçš„é—®é¢˜**ï¼šTab åˆ‡æ¢ > çŠ¶æ€æŒä¹…åŒ– > ç«æ€æ¡ä»¶
3. **å¯¹ä¸ç¡®å®šçš„é—®é¢˜å…ˆç›‘æ§**ï¼šè¿›ç¨‹æ¸…ç† Bug å…ˆæ·»åŠ æ—¥å¿—è§‚å¯Ÿ
4. **æŒç»­å›å½’æµ‹è¯•**ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆåè¿è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•
5. **è®°å½•ä¿®å¤æ•ˆæœ**ï¼šæ¯ä¸ªé—®é¢˜ä¿®å¤åè®°å½•ç”¨æˆ·åé¦ˆå’Œæ€§èƒ½æŒ‡æ ‡

### **é¢„æœŸæ•ˆæœ**

- **ç¬¬ä¸€é˜¶æ®µå**ï¼šç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡ï¼Œæ ¸å¿ƒåŠŸèƒ½ç¨³å®š
- **ç¬¬äºŒé˜¶æ®µå**ï¼šç³»ç»Ÿç¨³å®šæ€§è¾¾åˆ°ç”Ÿäº§çº§åˆ«
- **ç¬¬ä¸‰é˜¶æ®µå**ï¼šæ€§èƒ½å’Œä½“éªŒè¾¾åˆ°æœ€ä½³çŠ¶æ€

### **é£é™©æç¤º**

1. **Tab çŠ¶æ€ä¿å­˜**ï¼šéœ€è¦æ³¨æ„å†…å­˜å ç”¨ï¼Œå»ºè®®åªä¿å­˜æœ€è¿‘ 5 ä¸ª Tab çš„çŠ¶æ€
2. **localStorage é™åˆ¶**ï¼šæµè§ˆå™¨ localStorage æœ‰ 5-10MB é™åˆ¶ï¼Œéœ€è¦å®šæœŸæ¸…ç†
3. **æ–‡ä»¶é”å…¼å®¹æ€§**ï¼šWindows å’Œ Unix æ–‡ä»¶é”è¡Œä¸ºä¸åŒï¼Œéœ€è¦å……åˆ†æµ‹è¯•
4. **å‘åå…¼å®¹**ï¼šä¿®æ”¹ Tab æ¥å£æ—¶æ³¨æ„å‘åå…¼å®¹ï¼Œé¿å…ç ´åç°æœ‰åŠŸèƒ½

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### **å…³é”®æ–‡ä»¶æ¸…å•**
- `src/contexts/TabContext.tsx` - Tab çŠ¶æ€ç®¡ç†ï¼ˆP0 ä¿®å¤ï¼‰
- `src/components/ClaudeCodeSession.tsx` - ä¼šè¯ç»„ä»¶ï¼ˆP0 ä¿®å¤ï¼‰
- `src/components/claude-code-session/useClaudeMessages.ts` - æ¶ˆæ¯ç®¡ç†ï¼ˆå¯é€‰ï¼‰
- `src-tauri/src/process/registry.rs` - è¿›ç¨‹ç®¡ç†ï¼ˆP1 ç›‘æ§ï¼‰
- `src-tauri/src/commands/claude.rs` - æ–‡ä»¶è®¿é—®ï¼ˆP1 ä¿®å¤ï¼‰

### **æµ‹è¯•å‘½ä»¤**
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
npm test

# è¿è¡Œé›†æˆæµ‹è¯•
npm run test:integration

# æ€§èƒ½æµ‹è¯•
npm run test:performance

# å†…å­˜æ³„æ¼æ£€æµ‹
npm run test:memory
```

### **ç›‘æ§å‘½ä»¤**
```bash
# æŸ¥çœ‹è¿›ç¨‹æ¸…ç†æ—¥å¿—
tail -f ~/.claude/logs/process_cleanup.log

# æŸ¥çœ‹ä¼šè¯çŠ¶æ€
localStorage.getItem('session_*')

# æŸ¥çœ‹å†…å­˜å ç”¨
chrome://inspect/#devices
```